# .github/workflows/main.yml

name: Generate Post and Deploy Blog

# ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° ì„¤ì •
on:
  schedule:
    - cron: '0 4 * * 1-5'  # ìƒˆ ì„¤ì •: ì›”~ê¸ˆ ì˜¤í›„ 1:00 KST (ì›”~ê¸ˆ 04:00 UTC)


  # 2. main ë¸Œëœì¹˜ì— push ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ì‹¤í–‰
  push:
    branches:
      - master # ë˜ëŠ” master ë“± ê¸°ë³¸ ë¸Œëœì¹˜ ì´ë¦„

  # 3. ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì • (ì„ íƒ ì‚¬í•­)
  workflow_dispatch:

jobs:
  # ì²« ë²ˆì§¸ ì¡: law.py ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰í•˜ì—¬ ìƒˆ í¬ìŠ¤íŠ¸ ìƒì„± ë° main ë¸Œëœì¹˜ì— í‘¸ì‹œ
  generate-post:
    # ìŠ¤ì¼€ì¤„ ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰ ì‹œì—ë§Œ ì´ ì¡ ì‹¤í–‰
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    # ìƒì„±ëœ íŒŒì¼ì„ main ë¸Œëœì¹˜ì— í‘¸ì‹œí•  ìˆ˜ ìˆë„ë¡ ì“°ê¸° ê¶Œí•œ ì„¤ì •
    permissions:
      contents: write

    steps:
      - name: Checkout main branch ğŸ›ï¸
        uses: actions/checkout@v4
        with:
          ref: master # main ë¸Œëœì¹˜ë¥¼ ì²´í¬ì•„ì›ƒ

      - name: Set up Python ğŸ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10' # ë˜ëŠ” ì›í•˜ëŠ” Python ë²„ì „

      - name: Install Python Dependencies ğŸ“¦
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Chrome/ChromedriverëŠ” Selenium Managerê°€ ì²˜ë¦¬í•˜ë¯€ë¡œ ë³„ë„ ì„¤ì¹˜ ë¶ˆí•„ìš”í•  ìˆ˜ ìˆìŒ
      # ë§Œì•½ Runner í™˜ê²½ ë¬¸ì œ ì‹œ ì•„ë˜ ì£¼ì„ í•´ì œ ì‹œë„
      # - name: Setup Chrome # Chrome ì„¤ì¹˜ (í•„ìš”í•œ ê²½ìš°)
      #   uses: browser-actions/setup-chrome@v1

      - name: Run law.py to generate post ğŸ“
        run: python law.py
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }} # GitHub Secretsì—ì„œ API í‚¤ ê°€ì ¸ì˜¤ê¸°

      - name: Commit and Push new post file ğŸš€
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          # git pull # ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•´ Pull ë¨¼ì € ì‹¤í–‰ (ì„ íƒ ì‚¬í•­)
          # ìƒì„±ëœ íŒŒì¼ í™•ì¸ (ìŠ¤í¬ë¦½íŠ¸ê°€ _articles/*.md í˜•íƒœë¡œ ìƒì„±í•œë‹¤ê³  ê°€ì •)
          git add _articles/*.md downloads/* # ë‹¤ìš´ë¡œë“œ í´ë” ë‚´ìš© ë³€ê²½ë„ í¬í•¨ (ì„ íƒ ì‚¬í•­)
          # ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ ì»¤ë°‹ ë° í‘¸ì‹œ
          git diff --staged --quiet || git commit -m "feat: Add new blog post from NARS report"
          git push origin master

  # ë‘ ë²ˆì§¸ ì¡: main ë¸Œëœì¹˜ í‘¸ì‹œ ì‹œ ë¸”ë¡œê·¸ ë¹Œë“œ ë° gh-pages ë¸Œëœì¹˜ë¡œ ë°°í¬
  deploy-blog:
    # main ë¸Œëœì¹˜ í‘¸ì‹œ ì‹œì—ë§Œ ì´ ì¡ ì‹¤í–‰ (generate-post ì¡ì´ ì™„ë£Œëœ í›„ì—ë„ ì‹¤í–‰ë¨)
    # generate-post ì¡ì´ ì„±ê³µì ìœ¼ë¡œ ìƒˆ ê¸€ì„ í‘¸ì‹œí•˜ë©´ ì´ ì¡ì´ íŠ¸ë¦¬ê±°ë¨
    needs: generate-post # ìŠ¤ì¼€ì¤„ ì‹¤í–‰ ì‹œ generate-post ì¡ì´ ì™„ë£Œëœ í›„ì— ì‹¤í–‰ë˜ë„ë¡ í•¨ (ì„ íƒì )
    # if ì¡°ê±´ ì¶”ê°€: generate-post ì¡ì´ ì‹¤í–‰ë˜ì—ˆê±°ë‚˜(ìŠ¤ì¼€ì¤„) ì§ì ‘ í‘¸ì‹œí–ˆì„ ë•Œë§Œ ì‹¤í–‰
    if: always() && (needs.generate-post.result == 'success' || github.event_name == 'push')
    runs-on: ubuntu-latest

    permissions:
      contents: write # ì´ ì¡ì—ì„œ GITHUB_TOKENì— ì“°ê¸° ê¶Œí•œ ë¶€ì—¬

    steps:
      - name: Checkout main branch ğŸ›ï¸
        uses: actions/checkout@v4
        with:
           ref: master # ë°°í¬í•  ì†ŒìŠ¤ì½”ë“œê°€ ìˆëŠ” ë¸Œëœì¹˜

      - name: Set up Node.js âš™ï¸
        uses: actions/setup-node@v4
        with:
          node-version: '18' # 'Handmade Blog'ê°€ ìš”êµ¬í•˜ëŠ” ë²„ì „ í™•ì¸ í•„ìš”
          cache: 'npm'

      - name: Install Node.js Dependencies ğŸ“¦
        run: npm ci

      - name: Build Blog ğŸ”§
        run: npm run build # 'dist' í´ë” ìƒì„±

      - name: Deploy to gh-pages branch ğŸš€
        uses: peaceiris/actions-gh-pages@v3 # ë˜ëŠ” v4 ë“± ìµœì‹  ë²„ì „ í™•ì¸
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist        # ë°°í¬í•  í´ë” (ë¹Œë“œ ê²°ê³¼ë¬¼)
          publish_branch: gh-pages   # ë°°í¬ ëŒ€ìƒ ë¸Œëœì¹˜
          user_name: 'github-actions[bot]' # ì»¤ë°‹ ì‚¬ìš©ì ì´ë¦„
          user_email: 'github-actions[bot]@users.noreply.github.com' # ì»¤ë°‹ ì‚¬ìš©ì ì´ë©”ì¼
          commit_message: "Deploy blog updates to gh-pages" # ì»¤ë°‹ ë©”ì‹œì§€